#!/bin/bash

##
#  Copyright 2013-2014 University Of Southern California
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing,
#  software distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
##

# Author: Mats Rynge <rynge@isi.edu>

#############################################################################

set -e

function usage()
{
    cat >&2 <<EOF
Usage: run-glidein [-h] [-w PATH] [-t MINS] [-s START] [-p SECRET] -c HOST

  -h        Show this help message
  -c HOST   The hostname of the HTCondor central manager
  -p SECRET The HTCondor pool password.
  -s START  Start expression for the STARTD.
  -t HOURS  Number of hours to accept new jobs. 
  -w PATH   Use PATH as work directory. If not specified, \$TMP is used.
  -u URL    URL to a HTCondor tarball to be used.

EOF
    exit 0
}


function cleanup()
{
    # prevent mulitple cleanups
    if [ "x$CLEAN_UP_DONE" = "x1" ]; then
        return
    fi
    export CLEAN_UP_DONE=1

    kill -9 $TAIL_PID

    kill $MASTER_PID >/dev/null 2>&1
    wait $MASTER_PID

    echo
    echo "Cleaning up..."
    rm -rf $_CONDOR_LOCAL_DIR
}


#######################################################################
#
#  main
# 

while getopts "hc:p:t:w:u:" arg; do
    case $arg in
        h)
            usage
            ;;
        c)
            CONDOR_HOST=$OPTARG
            ;;
        p)
            POOL_PASSWORD=$OPTARG
            ;;
        s)
            START_EXPR=$OPTARG
            ;;
        t)
            HOURS_UNTIL_RETIREMENT=$OPTARG
            ;;
        w)
            WORK_DIR=$OPTARG
            ;;
        u)
            CONDOR_TARBALL=$OPTARG
            ;;
        \?)
            usage
            ;;
        :)
            usage
            ;;
    esac
done

if [ "x$CONDOR_HOST" == "x" ]; then
    echo "-c is a required parameter" >&2
    usage
fi
if [ "x$POOL_PASSWORD" == "x" ]; then
    echo "-p is a required parameter" >&2
    usage
fi
if [ "x$START_EXPR" == "x" ]; then
    START_EXPR="True"
fi
if [ "x$HOURS_UNTIL_RETIREMENT" == "x" ]; then
    HOURS_UNTIL_RETIREMENT=12
fi
if [ "x$CONDOR_TARBALL" == "x" ]; then
    CONDOR_TARBALL="http://workflow.isi.edu/HTCondor/condor-8.2.1-x86_64_RedHat6-unstripped.tar.gz"
fi

# empty PATH?
if [ "x$PATH" = "x" ]; then
    export PATH=/usr/bin:/bin
fi

# workdir
if [ "x$WORK_DIR" == "x" ]; then
    if [ "x$TMP" == "x" ]; then
        WORK_DIR=/tmp
    else
        WORK_DIR=$TMP
    fi
fi
WORK_DIR=`mktemp -d $WORK_DIR/condor-local.XXXXXXXX`
echo "Work dir is $WORK_DIR"

cd $WORK_DIR

# download HTCondor
echo "Downloading and setting up HTCondor..."
wget -q -O condor.tar.gz $CONDOR_TARBALL
tar xzf condor.tar.gz
rm -f condor.tar.gz
mv condor-* condor

export _CONDOR_RELEASE_DIR=$WORK_DIR/condor
export PATH=$_CONDOR_RELEASE_DIR/bin:$_CONDOR_RELEASE_DIR/sbin:$PATH

# temp directory for this instance
export _CONDOR_LOCAL_DIR="$WORK_DIR/var"
echo
echo "HTCondor Local directory for this glidein is $_CONDOR_LOCAL_DIR"

trap cleanup INT TERM

mkdir -p $_CONDOR_LOCAL_DIR/execute
mkdir -p $_CONDOR_LOCAL_DIR/log
mkdir -p $_CONDOR_LOCAL_DIR/spool

# condor config
export CONDOR_CONFIG=$WORK_DIR/condor/etc/condor_config
export MY_HOSTNAME=`hostname -f`
cat >$CONDOR_CONFIG <<EOF
# HTCondor config generated by GlideinLite

DAEMON_LIST = MASTER, STARTD

CONDOR_HOST = $CONDOR_HOST
CCB_ADDRESS = $CONDOR_HOST
PRIVATE_NETWORK_NAME = $MY_HOSTNAME
UID_DOMAIN = $MY_HOSTNAME
FILESYSTEM_DOMAIN = $MY_HOSTNAME

LOCAL_DIR=$_CONDOR_LOCAL_DIR

LOG=\$(LOCAL_DIR)/log
#ALL_DEBUG               = D_FULLDEBUG

UPDATE_COLLECTOR_WITH_TCP = True

SEC_DAEMON_AUTHENTICATION_METHODS = PASSWORD
SEC_CLIENT_AUTHENTICATION_METHODS = PASSWORD

SEC_PASSWORD_FILE = $WORK_DIR/condor/etc/pool_password

# dynamic slots
SLOT_TYPE_1 = cpus=100%,disk=100%,swap=100%
SLOT_TYPE_1_PARTITIONABLE = TRUE
NUM_SLOTS = 1
NUM_SLOTS_TYPE_1 = 1

# default policy
START = $START_EXPR
SUSPEND = False
CONTINUE = True
PREEMPT = False
KILL = False

EOF

# set the pool password
echo "Setting the pool password"
condor_store_cred -p "$POOL_PASSWORD" -f $WORK_DIR/condor/etc/pool_password add

echo "Starting HTCondor..."

touch $_CONDOR_LOCAL_DIR/log/MasterLog $_CONDOR_LOCAL_DIR/log/StartLog
tail -F $_CONDOR_LOCAL_DIR/log/MasterLog $_CONDOR_LOCAL_DIR/log/StartLog &
TAIL_PID=$!

MINS_UNTIL_RETIREMENT=$(($HOURS_UNTIL_RETIREMENT * 60))
condor_master -f -r $MINS_UNTIL_RETIREMENT &
MASTER_PID=$!
wait $MASTER_PID

cleanup

